{% extends "base.html" %}

{% block title %}Random Coffee - Edit Profile{% endblock %}

{% block content %}
<div class="text-center mb-4">
    <h1 class="mb-3">Your Profile</h1>
    <p class="lead">Tell us about yourself to find the best matches!</p>
</div>

<form id="profileForm" class="needs-validation" novalidate>
    <div class="card mb-4">
        <div class="card-header">
            Basic Information
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label for="fullName" class="form-label">Full Name</label>
                <input type="text" class="form-control" id="fullName" name="fullName" required>
                <div class="invalid-feedback">
                    Please provide your name.
                </div>
            </div>
            
            <div class="mb-3">
                <label for="bio" class="form-label">About You</label>
                <textarea class="form-control" id="bio" name="bio" rows="3" placeholder="Tell us a bit about yourself, your background, what you do, etc."></textarea>
                <div class="form-text hint-text">
                    This helps others get to know you before meeting.
                </div>
            </div>
            
            <div class="mb-3">
                <label for="photoUrl" class="form-label">Profile Photo URL</label>
                <input type="url" class="form-control" id="photoUrl" name="photoUrl" placeholder="https://example.com/your-photo.jpg">
                <div class="form-text hint-text">
                    Optional: Add a URL to your profile photo.
                </div>
            </div>
        </div>
    </div>
    
    <div class="card mb-4">
        <div class="card-header">
            Interests
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">Select Your Interests</label>
                <div class="row">
                    <div class="col-6">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" value="coffee" id="coffee" name="interests">
                            <label class="form-check-label" for="coffee">Coffee</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" value="technology" id="technology" name="interests">
                            <label class="form-check-label" for="technology">Technology</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" value="business" id="business" name="interests">
                            <label class="form-check-label" for="business">Business</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" value="art" id="art" name="interests">
                            <label class="form-check-label" for="art">Art</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" value="music" id="music" name="interests">
                            <label class="form-check-label" for="music">Music</label>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" value="sports" id="sports" name="interests">
                            <label class="form-check-label" for="sports">Sports</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" value="travel" id="travel" name="interests">
                            <label class="form-check-label" for="travel">Travel</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" value="food" id="food" name="interests">
                            <label class="form-check-label" for="food">Food</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" value="books" id="books" name="interests">
                            <label class="form-check-label" for="books">Books</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" value="science" id="science" name="interests">
                            <label class="form-check-label" for="science">Science</label>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <label for="otherInterests" class="form-label">Other Interests</label>
                    <input type="text" class="form-control" id="otherInterests" name="otherInterests" placeholder="Separate with commas (e.g., hiking, photography, cooking)">
                </div>
            </div>
        </div>
    </div>
    
    <div class="card mb-4">
        <div class="card-header">
            Location & Preferences
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">Your Location</label>
                <div class="d-grid">
                    <button type="button" id="locationBtn" class="btn btn-outline-primary">
                        <i class="bi bi-geo-alt"></i> Share Your Location
                    </button>
                </div>
                <div id="locationInfo" class="mt-2 d-none">
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle-fill"></i> Location shared successfully!
                    </div>
                </div>
                <input type="hidden" id="locationLat" name="locationLat">
                <input type="hidden" id="locationLon" name="locationLon">
            </div>
            
            <div class="mb-3">
                <label for="radius" class="form-label">Match Radius (km)</label>
                <input type="range" class="form-range" min="1" max="50" step="1" id="radius" name="radius" value="10">
                <div class="d-flex justify-content-between">
                    <span>1 km</span>
                    <span id="radiusValue">10 km</span>
                    <span>50 km</span>
                </div>
            </div>
            
            <div class="mb-3">
                <label for="preferredLanguage" class="form-label">Preferred Language</label>
                <select class="form-select" id="preferredLanguage" name="preferredLanguage" required>
                    <option value="" selected disabled>Select language</option>
                    <option value="en">English</option>
                    <option value="es">Spanish</option>
                    <option value="fr">French</option>
                    <option value="de">German</option>
                    <option value="it">Italian</option>
                    <option value="ru">Russian</option>
                    <option value="zh">Chinese</option>
                    <option value="ja">Japanese</option>
                    <option value="ko">Korean</option>
                    <option value="ar">Arabic</option>
                </select>
                <div class="invalid-feedback">
                    Please select your preferred language.
                </div>
            </div>
        </div>
    </div>
    
    <div class="card mb-4">
        <div class="card-header">
            Availability
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">Preferred Days</label>
                <div class="row">
                    <div class="col-6">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" value="Monday" id="monday" name="preferredDays">
                            <label class="form-check-label" for="monday">Monday</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" value="Tuesday" id="tuesday" name="preferredDays">
                            <label class="form-check-label" for="tuesday">Tuesday</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" value="Wednesday" id="wednesday" name="preferredDays">
                            <label class="form-check-label" for="wednesday">Wednesday</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" value="Thursday" id="thursday" name="preferredDays">
                            <label class="form-check-label" for="thursday">Thursday</label>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" value="Friday" id="friday" name="preferredDays">
                            <label class="form-check-label" for="friday">Friday</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" value="Saturday" id="saturday" name="preferredDays">
                            <label class="form-check-label" for="saturday">Saturday</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" value="Sunday" id="sunday" name="preferredDays">
                            <label class="form-check-label" for="sunday">Sunday</label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-6">
                    <label for="preferredTimeStart" class="form-label">Preferred Time (Start)</label>
                    <input type="time" class="form-control" id="preferredTimeStart" name="preferredTimeStart">
                </div>
                <div class="col-6">
                    <label for="preferredTimeEnd" class="form-label">Preferred Time (End)</label>
                    <input type="time" class="form-control" id="preferredTimeEnd" name="preferredTimeEnd">
                </div>
            </div>
            
            <div class="mb-3">
                <label for="timezone" class="form-label">Your Timezone</label>
                <select class="form-select" id="timezone" name="timezone" required>
                    <option value="" selected disabled>Select timezone</option>
                    <option value="UTC">UTC</option>
                    <option value="Europe/London">London (GMT)</option>
                    <option value="Europe/Paris">Paris (CET)</option>
                    <option value="Europe/Moscow">Moscow (MSK)</option>
                    <option value="America/New_York">New York (EST)</option>
                    <option value="America/Los_Angeles">Los Angeles (PST)</option>
                    <option value="Asia/Tokyo">Tokyo (JST)</option>
                    <option value="Asia/Shanghai">Shanghai (CST)</option>
                    <option value="Australia/Sydney">Sydney (AEST)</option>
                </select>
                <div class="invalid-feedback">
                    Please select your timezone.
                </div>
            </div>
        </div>
    </div>
    
    <div class="d-grid gap-2 mb-4">
        <button type="submit" id="saveBtn" class="btn btn-primary">
            <i class="bi bi-save"></i> Save Profile
        </button>
        <button type="button" id="cancelBtn" class="btn btn-outline-secondary">
            <i class="bi bi-x-circle"></i> Cancel
        </button>
    </div>
</form>

<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="successModalLabel">Profile Saved</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Your profile has been saved successfully!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="closeModalBtn">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tg = window.Telegram.WebApp;
        const form = document.getElementById('profileForm');
        const radiusInput = document.getElementById('radius');
        const radiusValue = document.getElementById('radiusValue');
        const locationBtn = document.getElementById('locationBtn');
        const locationInfo = document.getElementById('locationInfo');
        const locationLat = document.getElementById('locationLat');
        const locationLon = document.getElementById('locationLon');
        const cancelBtn = document.getElementById('cancelBtn');
        const successModal = new bootstrap.Modal(document.getElementById('successModal'));
        const closeModalBtn = document.getElementById('closeModalBtn');
        
        // Update radius value display
        radiusInput.addEventListener('input', function() {
            radiusValue.textContent = this.value + ' km';
        });
        
        // Handle location button click
        locationBtn.addEventListener('click', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    locationLat.value = position.coords.latitude;
                    locationLon.value = position.coords.longitude;
                    locationInfo.classList.remove('d-none');
                    locationBtn.innerHTML = '<i class="bi bi-geo-alt-fill"></i> Location Shared';
                    locationBtn.classList.remove('btn-outline-primary');
                    locationBtn.classList.add('btn-success');
                }, function(error) {
                    alert('Error getting location: ' + error.message);
                });
            } else {
                alert('Geolocation is not supported by this browser.');
            }
        });
        
        // Get user data from Telegram WebApp
        const user = tg.initDataUnsafe?.user || {};
        
        // Fetch existing user data if available
        fetch(`/api/user/${user.id}`)
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else if (response.status === 404) {
                    // New user, pre-fill name from Telegram
                    document.getElementById('fullName').value = user.first_name + (user.last_name ? ' ' + user.last_name : '');
                    return null;
                } else {
                    throw new Error('Error fetching user data');
                }
            })
            .then(userData => {
                if (userData) {
                    // Pre-fill form with existing data
                    document.getElementById('fullName').value = userData.full_name || '';
                    document.getElementById('bio').value = userData.bio || '';
                    document.getElementById('photoUrl').value = userData.photo_url || '';
                    document.getElementById('radius').value = userData.radius || 10;
                    radiusValue.textContent = (userData.radius || 10) + ' km';
                    document.getElementById('preferredLanguage').value = userData.preferred_language || '';
                    document.getElementById('timezone').value = userData.timezone || '';
                    
                    // Set location if available
                    if (userData.location_lat && userData.location_lon) {
                        locationLat.value = userData.location_lat;
                        locationLon.value = userData.location_lon;
                        locationInfo.classList.remove('d-none');
                        locationBtn.innerHTML = '<i class="bi bi-geo-alt-fill"></i> Location Shared';
                        locationBtn.classList.remove('btn-outline-primary');
                        locationBtn.classList.add('btn-success');
                    }
                    
                    // Set preferred times if available
                    if (userData.preferred_time_start) {
                        document.getElementById('preferredTimeStart').value = userData.preferred_time_start.substring(0, 5);
                    }
                    if (userData.preferred_time_end) {
                        document.getElementById('preferredTimeEnd').value = userData.preferred_time_end.substring(0, 5);
                    }
                    
                    // Set interests
                    if (userData.interests && userData.interests.length > 0) {
                        const standardInterests = ['coffee', 'technology', 'business', 'art', 'music', 'sports', 'travel', 'food', 'books', 'science'];
                        const otherInterests = [];
                        
                        userData.interests.forEach(interest => {
                            const interestLower = interest.toLowerCase();
                            if (standardInterests.includes(interestLower)) {
                                document.getElementById(interestLower).checked = true;
                            } else {
                                otherInterests.push(interest);
                            }
                        });
                        
                        if (otherInterests.length > 0) {
                            document.getElementById('otherInterests').value = otherInterests.join(', ');
                        }
                    }
                    
                    // Set preferred days
                    if (userData.preferred_days && userData.preferred_days.length > 0) {
                        userData.preferred_days.forEach(day => {
                            const dayLower = day.toLowerCase();
                            document.getElementById(dayLower).checked = true;
                        });
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        
        // Handle form submission
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            
            if (!form.checkValidity()) {
                event.stopPropagation();
                form.classList.add('was-validated');
                return;
            }
            
            // Collect form data
            const interests = [];
            document.querySelectorAll('input[name="interests"]:checked').forEach(checkbox => {
                interests.push(checkbox.value);
            });
            
            // Add other interests
            const otherInterestsValue = document.getElementById('otherInterests').value;
            if (otherInterestsValue) {
                otherInterestsValue.split(',').forEach(interest => {
                    const trimmed = interest.trim();
                    if (trimmed) {
                        interests.push(trimmed);
                    }
                });
            }
            
            // Collect preferred days
            const preferredDays = [];
            document.querySelectorAll('input[name="preferredDays"]:checked').forEach(checkbox => {
                preferredDays.push(checkbox.value);
            });
            
            // Создаём объект profileData, как и раньше
            const profileData = {
                user_id: user.id, // добавляем ID пользователя из Telegram
                full_name: document.getElementById('fullName').value,
                bio: document.getElementById('bio').value,
                interests: interests,
                location_lat: parseFloat(locationLat.value) || null,
                location_lon: parseFloat(locationLon.value) || null,
                radius: parseInt(document.getElementById('radius').value),
                preferred_language: document.getElementById('preferredLanguage').value,
                photo_url: document.getElementById('photoUrl').value || null,
                preferred_days: preferredDays,
                preferred_time_start: document.getElementById('preferredTimeStart').value || null,
                preferred_time_end: document.getElementById('preferredTimeEnd').value || null,
                timezone: document.getElementById('timezone').value
            };

            // Формируем данные для отправки с указанием действия
            const webAppData = {
                action: 'update_profile',
                profile: profileData
            };

            // Отправляем данные на бекенд
            fetch("/api/webapp/data", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(webAppData)
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error("Error while updating profile");
                }
            })
            .then(data => {
                console.log("Ответ от сервера:", data);
                // Показываем модальное окно об успешном обновлении
                successModal.show();
            })
            .catch(error => {
                console.error('Error:', error);
            });

        });
        
        // Handle cancel button click
        cancelBtn.addEventListener('click', function() {
            tg.close();
        });
        
        // Handle close modal button click
        closeModalBtn.addEventListener('click', function() {
            tg.close();
        });
    });
</script>
{% endblock %}